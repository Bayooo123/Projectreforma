generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  extensions = [uuid_ossp(map: "uuid-ossp", schema: "extensions"), vector]
}

model Workspace {
  id                String                @id @default(cuid())
  name              String
  slug              String                @unique
  ownerId           String
  plan              String                @default("free")
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  firmCode          String?               @unique
  joinPassword      String?
  letterheadUrl     String?
  revenuePin        String?
  inviteLinkToken   String?               @unique
  bankAccounts      BankAccount[]
  briefs            Brief[]
  clients           Client[]
  draftingTemplates DraftingTemplate[]
  expenses          Expense[]
  invitations       Invitation[]
  matters           Matter[]
  tasks             Task[]
  owner             User                  @relation("WorkspaceOwner", fields: [ownerId], references: [id])
  emailConfig       WorkspaceEmailConfig?
  members           WorkspaceMember[]
  complianceTasks   ComplianceTask[]

  @@index([slug])
  @@index([firmCode])
}

model WorkspaceMember {
  id          String    @id @default(cuid())
  workspaceId String
  userId      String
  role        String
  joinedAt    DateTime  @default(now())
  designation String?
  status      String    @default("active")
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@index([userId])
}

model Invitation {
  id          String    @id @default(cuid())
  workspaceId String
  email       String
  role        String
  token       String    @unique
  invitedBy   String
  status      String    @default("pending")
  expiresAt   DateTime
  createdAt   DateTime  @default(now())
  acceptedAt  DateTime?
  inviter     User      @relation(fields: [invitedBy], references: [id])
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([email])
}

model User {
  id                   String                @id @default(cuid())
  name                 String?
  email                String                @unique
  password             String?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  emailVerified        DateTime?
  phone                String?
  image                String?
  jobTitle             String?
  lawyerToken          String?               @unique
  accounts             Account[]
  apiKeys              ApiKey[]
  briefs               Brief[]
  BriefActivityLog     BriefActivityLog[]
  clientCommunications ClientCommunication[]
  draftingSessions     DraftingSession[]
  draftingTemplates    DraftingTemplate[]
  invitations          Invitation[]
  activityLogs         MatterActivityLog[]
  sessions             Session[]
  createdTasks         Task[]                @relation("CreatedTasks")
  assignedTasks        Task[]                @relation("AssignedTasks")
  ownedWorkspaces      Workspace[]           @relation("WorkspaceOwner")
  workspaces           WorkspaceMember[]
  courtAppearances     CourtDate[]           @relation("CourtAppearances")
  matterLawyer         MatterLawyer[]
  acknowledgedCompliance ComplianceTask[] @relation("AcknowledgedBy")
  complianceHistory      ComplianceHistory[]

  @@index([email])
  @@index([lawyerToken])
}

model BankAccount {
  id            String    @id @default(cuid())
  workspaceId   String
  bankName      String
  accountNumber String
  accountName   String
  currency      String    @default("NGN")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  workspace     Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
}

model ApiKey {
  id          String    @id @default(cuid())
  userId      String
  workspaceId String
  name        String
  keyHash     String    @unique
  keyPrefix   String
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  revokedAt   DateTime?
  createdAt   DateTime  @default(now())
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([keyHash])
  @@index([userId])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Notification {
  id               String    @id @default(cuid())
  type             String
  title            String
  message          String
  recipientId      String
  recipientType    String
  relatedMatterId  String?
  relatedBriefId   String?
  priority         String    @default("medium")
  status           String    @default("unread")
  channels         String?
  createdAt        DateTime  @default(now())
  readAt           DateTime?
  metadata         Json?
  relatedInvoiceId String?
  relatedPaymentId String?
  updatedAt        DateTime  @updatedAt
  brief            Brief?    @relation(fields: [relatedBriefId], references: [id])
  invoice          Invoice?  @relation(fields: [relatedInvoiceId], references: [id])
  matter           Matter?   @relation(fields: [relatedMatterId], references: [id])
  payment          Payment?  @relation(fields: [relatedPaymentId], references: [id])

  @@index([recipientId, status])
  @@index([createdAt])
}

model NotificationRule {
  id          String   @id @default(cuid())
  name        String
  description String?
  triggerType String
  conditions  String
  actions     String
  enabled     Boolean  @default(true)
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([enabled])
}

model Matter {
  id                   String                @id @default(cuid())
  caseNumber           String?               @unique
  name                 String
  clientId             String?
  clientNameRaw        String?
  workspaceId          String
  court                String?
  judge                String?
  status               String                @default("active")
  nextCourtDate        DateTime?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  lastActivityAt       DateTime              @default(now())
  lastClientContact    DateTime?
  submittingLawyerId    String?
  submittingLawyerToken String?
  submittingLawyerName  String?
  briefs               Brief[]
  clientCommunications ClientCommunication[]
  courtDates           CourtDate[]
  invoices             Invoice[]
  lawyers              MatterLawyer[]
  client               Client?               @relation(fields: [clientId], references: [id])
  workspace            Workspace             @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  activityLogs         MatterActivityLog[]
  notifications        Notification[]
  tasks                Task[]

  @@index([workspaceId])
  @@index([lastActivityAt])
  @@index([nextCourtDate])
  @@index([submittingLawyerId])
}

model MatterLawyer {
  id          String  @id @default(cuid())
  matterId    String
  lawyerId    String
  role        String // "lead counsel", "co-counsel", "appearing"
  isAppearing Boolean @default(false)
  matter      Matter  @relation(fields: [matterId], references: [id], onDelete: Cascade)
  lawyer      User    @relation(fields: [lawyerId], references: [id], onDelete: Cascade)

  @@unique([matterId, lawyerId])
  @@index([lawyerId])
  @@index([matterId])
}

model CourtDate {
  id                     String                  @id @default(cuid())
  matterId               String
  date                   DateTime
  title                  String?
  proceedings            String?
  outcome                String?
  adjournedFor           String?
  submittingLawyerId    String?
  submittingLawyerToken String?
  submittingLawyerName  String?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  
  // Strict Hierarchy Fields (Mandatory)
  briefId                String
  clientId               String

  matter                 Matter                  @relation(fields: [matterId], references: [id], onDelete: Cascade)
  brief                  Brief                   @relation(fields: [briefId], references: [id])
  client                 Client                  @relation(fields: [clientId], references: [id])
  
  appearances            User[]                  @relation("CourtAppearances")
  scheduledNotifications ScheduledNotification[]

  @@index([matterId])
  @@index([briefId])
  @@index([clientId])
  @@index([date])
  @@index([submittingLawyerId])
}

model ScheduledNotification {
  id               String    @id @default(cuid())
  matterId         String
  courtDateId      String
  recipientId      String
  notificationType String // 'three_day', 'two_day', 'day_of'
  scheduledFor     DateTime
  status           String    @default("pending") // 'pending', 'sent', 'cancelled'
  sentAt           DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  courtDate        CourtDate @relation(fields: [courtDateId], references: [id], onDelete: Cascade)

  @@index([status, scheduledFor])
  @@index([matterId])
  @@index([courtDateId])
  @@index([recipientId])
}

model MatterActivityLog {
  id           String   @id @default(cuid())
  matterId     String
  activityType String
  description  String
  performedBy  String
  timestamp    DateTime @default(now())
  matter       Matter   @relation(fields: [matterId], references: [id], onDelete: Cascade)
  user         User     @relation(fields: [performedBy], references: [id])

  @@index([matterId, timestamp])
}

model ClientCommunication {
  id                String   @id @default(cuid())
  matterId          String
  clientId          String
  communicationType String
  subject           String
  summary           String
  sentBy            String
  sentAt            DateTime @default(now())
  client            Client   @relation(fields: [clientId], references: [id])
  matter            Matter   @relation(fields: [matterId], references: [id], onDelete: Cascade)
  user              User     @relation(fields: [sentBy], references: [id])

  @@index([matterId])
  @@index([clientId])
  @@index([sentAt])
}

model Brief {
  id             String             @id @default(cuid())
  briefNumber    String             @unique
  name           String
  clientId       String?
  matterId       String?
  lawyerId       String
  workspaceId    String
  category       String
  status         String             @default("active")
  dueDate        DateTime?
  description    String?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  inboundEmailId String             @unique @default(uuid())
  client         Client?            @relation(fields: [clientId], references: [id])
  lawyer         User               @relation(fields: [lawyerId], references: [id])
  matter         Matter?            @relation(fields: [matterId], references: [id])
  workspace      Workspace          @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  activityLogs   BriefActivityLog[]
  documents      Document[]
  notifications  Notification[]
  tasks          Task[]
  courtDates     CourtDate[] // Hierarchy back-relation

  @@index([lawyerId])
  @@index([workspaceId])
  @@index([dueDate])
  @@index([status])
}

model Document {
  id         String          @id @default(cuid())
  name       String
  url        String
  type       String
  size       Int
  briefId    String
  uploadedAt DateTime        @default(now())
  ocrStatus  String          @default("pending")
  ocrText    String?
  brief      Brief           @relation(fields: [briefId], references: [id], onDelete: Cascade)
  chunks     DocumentChunk[]

  @@index([briefId])
}

model DocumentChunk {
  id         String                 @id @default(cuid())
  documentId String
  content    String
  embedding  Unsupported("vector")?
  chunkIndex Int
  metadata   Json?
  document   Document               @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
}

model Client {
  id                   String                @id @default(cuid())
  name                 String
  email                String                @unique
  phone                String?
  company              String?
  industry             String?
  status               String                @default("active")
  workspaceId          String
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  briefs               Brief[]
  workspace            Workspace             @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  clientCommunications ClientCommunication[]
  invoices             Invoice[]
  matters              Matter[]
  payments             Payment[]
  courtDates           CourtDate[] // Hierarchy back-relation

  @@index([email])
  @@index([workspaceId])
}

model Invoice {
  id                   String         @id @default(cuid())
  invoiceNumber        String         @unique
  clientId             String
  matterId             String?
  date                 DateTime       @default(now())
  dueDate              DateTime?
  status               String         @default("pending")
  billToName           String
  billToAddress        String?
  billToCity           String?
  billToState          String?
  attentionTo          String?
  notes                String?
  subtotal             Int            @default(0)
  vatRate              Float          @default(7.5)
  vatAmount            Int            @default(0)
  securityChargeRate   Float          @default(1.0)
  securityChargeAmount Int            @default(0)
  totalAmount          Int            @default(0)
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  followUpSent         Boolean        @default(false)
  client               Client         @relation(fields: [clientId], references: [id], onDelete: Cascade)
  matter               Matter?        @relation(fields: [matterId], references: [id])
  items                InvoiceItem[]
  notifications        Notification[]
  payments             Payment[]

  @@index([clientId])
  @@index([matterId])
  @@index([status])
  @@index([date])
}

model InvoiceItem {
  id          String   @id @default(cuid())
  invoiceId   String
  description String
  amount      Int
  quantity    Int      @default(1)
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

model Payment {
  id            String         @id @default(cuid())
  clientId      String
  invoiceId     String?
  amount        Int
  date          DateTime       @default(now())
  method        String
  reference     String?
  createdAt     DateTime       @default(now())
  notifications Notification[]
  client        Client         @relation(fields: [clientId], references: [id], onDelete: Cascade)
  invoice       Invoice?       @relation(fields: [invoiceId], references: [id])

  @@index([clientId])
  @@index([invoiceId])
}

model Expense {
  id          String    @id @default(cuid())
  workspaceId String
  category    String
  amount      Int
  description String
  date        DateTime  @default(now())
  reference   String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([date])
}

model Task {
  id           String    @id @default(cuid())
  title        String
  description  String?
  assignedToId String?
  assignedById String
  workspaceId  String
  matterId     String?
  briefId      String?
  priority     String    @default("medium")
  status       String    @default("pending")
  dueDate      DateTime?
  completedAt  DateTime?
  source       String    @default("manual")
  sourceEmail  String?
  emailSubject String?
  emailBody    String?
  aiConfidence Int?
  requirements Json?
  attachments  Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  assignedBy   User      @relation("CreatedTasks", fields: [assignedById], references: [id])
  assignedTo   User?     @relation("AssignedTasks", fields: [assignedToId], references: [id])
  brief        Brief?    @relation(fields: [briefId], references: [id])
  matter       Matter?   @relation(fields: [matterId], references: [id])
  workspace    Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([assignedToId, status, dueDate])
  @@index([workspaceId, status])
  @@index([sourceEmail])
  @@index([dueDate])
}

model WorkspaceEmailConfig {
  id               String    @id @default(cuid())
  workspaceId      String    @unique
  emailAddress     String    @unique
  isActive         Boolean   @default(true)
  emailIntegration Json?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  workspace        Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
}

model BriefActivityLog {
  id           String   @id @default(cuid())
  briefId      String
  activityType String
  description  String
  metadata     Json?
  performedBy  String?
  timestamp    DateTime @default(now())
  brief        Brief    @relation(fields: [briefId], references: [id], onDelete: Cascade)
  user         User?    @relation(fields: [performedBy], references: [id])

  @@index([briefId, timestamp])
}

model DraftingTemplate {
  id          String             @id @default(cuid())
  name        String
  description String?
  category    String
  workspaceId String?
  authorId    String
  isPublished Boolean            @default(false)
  version     Int                @default(1)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  nodes       DraftingNode[]
  sessions    DraftingSession[]
  author      User               @relation(fields: [authorId], references: [id])
  workspace   Workspace?         @relation(fields: [workspaceId], references: [id])
  variables   DraftingVariable[]

  @@index([workspaceId])
}

model DraftingNode {
  id           String             @id @default(cuid())
  templateId   String
  type         String
  content      String
  helpText     String?
  order        Int
  variableName String?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  template     DraftingTemplate   @relation(fields: [templateId], references: [id], onDelete: Cascade)
  responses    DraftingResponse[]
  options      NodeOption[]

  @@index([templateId, order])
}

model NodeOption {
  id         String       @id @default(cuid())
  nodeId     String
  label      String
  value      String
  nextNodeId String?
  node       DraftingNode @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  @@index([nodeId])
}

model DraftingVariable {
  id           String           @id @default(cuid())
  templateId   String
  name         String
  label        String
  type         String
  required     Boolean          @default(true)
  defaultValue String?
  template     DraftingTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, name])
}

model DraftingSession {
  id            String             @id @default(cuid())
  templateId    String
  userId        String
  status        String
  currentStepId String?
  mode          String             @default("template")
  context       Json?
  variables     Json?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  responses     DraftingResponse[]
  template      DraftingTemplate   @relation(fields: [templateId], references: [id])
  user          User               @relation(fields: [userId], references: [id])

  @@index([userId, status])
}

model DraftingResponse {
  id        String          @id @default(cuid())
  sessionId String
  nodeId    String
  value     String
  timestamp DateTime        @default(now())
  node      DraftingNode    @relation(fields: [nodeId], references: [id])
  session   DraftingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, nodeId])
}

model Waitlist {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  firmName  String?
  market    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
}

model ComplianceObligation {
  id                 String           @id @default(cuid())
  tier               String           // "local", "state", "federal"
  regulatoryBody     String
  nature             String           // "payment", "filing", "return", "registration"
  actionRequired     String
  procedure          String           // Details on how to comply
  frequency          String           // "monthly", "quarterly", "annually", "one-time"
  dueDateDescription String?          // Text description of due date logic
  jurisdiction       String           @default("Federal") // "Federal", "Lagos", etc.
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  tasks              ComplianceTask[]
}

model ComplianceTask {
  id                String              @id @default(cuid())
  obligationId      String
  workspaceId       String
  status            String              @default("pending") // "pending", "due_soon", "overdue", "complied"
  dueDate           DateTime?
  period            String?             // e.g., "Jan 2024", "Q1 2024"
  evidenceUrl       String?
  acknowledgedAt    DateTime?
  acknowledgedBy    String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  obligation        ComplianceObligation @relation(fields: [obligationId], references: [id])
  workspace         Workspace           @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user              User?               @relation("AcknowledgedBy", fields: [acknowledgedBy], references: [id])
  history           ComplianceHistory[]

  @@index([workspaceId, status])
  @@index([dueDate])
}

model ComplianceHistory {
  id               String         @id @default(cuid())
  taskId           String
  action           String         // "status_change", "evidence_upload", "acknowledgement"
  description      String
  performedBy      String
  timestamp        DateTime       @default(now())
  task             ComplianceTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user             User           @relation(fields: [performedBy], references: [id])

  @@index([taskId])
}
