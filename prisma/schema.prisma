// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
  extensions = [vector]
}

// ============================================
// AUTHENTICATION & WORKSPACE MODELS
// ============================================

model Workspace {
  id            String   @id @default(cuid())
  name          String // "ASCO LP"
  slug          String   @unique // "asco-lp"
  ownerId       String
  plan          String   @default("free") // 'free' | 'pro' | 'enterprise'
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt


  // Security
  revenuePin String? // 5-digit PIN to unlock revenue visibility

  // Firm Login Fields
  joinPassword String? // Hashed shared password for firm login
  firmCode     String? @unique // Unique code for joining (e.g. "ASCO")
  inviteLinkToken String? @unique // Magic Link Token (Slack-style join)
  letterheadUrl String? // URL to uploaded letterhead image

  owner       User                  @relation("WorkspaceOwner", fields: [ownerId], references: [id])
  members     WorkspaceMember[]
  invitations Invitation[]
  matters     Matter[]
  clients     Client[]
  briefs      Brief[]
  expenses    Expense[]
  tasks       Task[]
  emailConfig WorkspaceEmailConfig?
  bankAccounts BankAccount[]
  draftingTemplates DraftingTemplate[]

  @@index([slug])
  @@index([firmCode])
}

model WorkspaceMember {
  id          String @id @default(cuid())
  workspaceId String
  userId      String
  role        String // 'owner' | 'partner' | 'lawyer' | 'staff'

  // New Role/Status Fields
  designation String? // e.g. "Senior Associate"
  status      String  @default("active") // 'pending' | 'active' | 'rejected'

  joinedAt DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@index([userId])
}

model Invitation {
  id          String    @id @default(cuid())
  workspaceId String
  email       String
  role        String // 'partner' | 'lawyer' | 'staff'
  token       String    @unique
  invitedBy   String
  status      String    @default("pending") // 'pending' | 'accepted' | 'expired'
  expiresAt   DateTime
  createdAt   DateTime  @default(now())
  acceptedAt  DateTime?

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  inviter   User      @relation(fields: [invitedBy], references: [id])

  @@index([token])
  @@index([email])
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String? // Hashed with bcrypt (Optional for OAuth users)
  phone         String? // Phone number
  jobTitle      String? // e.g. "Senior Associate"
  accounts      Account[]
  sessions      Session[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspaces WorkspaceMember[]
  invitations Invitation[] // Invitations sent by this user
  briefs      Brief[]

  // App Relations
  ownedWorkspaces      Workspace[]           @relation("WorkspaceOwner")
  assignedMatters      Matter[]              @relation("AssignedMatters")
  activityLogs         MatterActivityLog[]
  clientCommunications ClientCommunication[]
  assignedTasks        Task[]                @relation("AssignedTasks")
  createdTasks         Task[]                @relation("CreatedTasks")
  BriefActivityLog     BriefActivityLog[]
  draftingTemplates    DraftingTemplate[]
  draftingSessions     DraftingSession[]

  @@index([email])
}

model BankAccount {
  id            String   @id @default(cuid())
  workspaceId   String
  bankName      String   // "GTBank"
  accountNumber String   // "0123456789"
  accountName   String   // "ASCO LP"
  currency      String   @default("NGN") // "NGN", "USD", etc.
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  workspace     Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
}



model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// NOTIFICATION ENGINE MODELS
// ============================================

model Notification {
  id              String    @id @default(cuid())
  type            String // 'alert' | 'info' | 'success' | 'warning' | 'critical'
  title           String
  message         String
  recipientId     String
  recipientType   String // 'lawyer' | 'client' | 'partner' | 'staff'
  relatedMatterId String?
  relatedBriefId  String?
  priority        String // 'low' | 'medium' | 'high' | 'critical'
  status          String    @default("unread") // 'unread' | 'read' | 'dismissed' | 'actioned'
  channels        String // JSON array: ['in-app', 'email', 'sms']
  createdAt       DateTime  @default(now())
  readAt          DateTime?
  actionedAt      DateTime?

  matter Matter? @relation(fields: [relatedMatterId], references: [id])
  brief  Brief?  @relation(fields: [relatedBriefId], references: [id])

  @@index([recipientId, status])
  @@index([createdAt])
}

model NotificationRule {
  id          String   @id @default(cuid())
  name        String
  description String?
  triggerType String // 'time' | 'event' | 'inactivity'
  conditions  String // JSON object
  actions     String // JSON object
  enabled     Boolean  @default(true)
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([enabled])
}

model Matter {
  id                String    @id @default(cuid())
  caseNumber        String    @unique
  name              String
  clientId          String
  assignedLawyerId  String
  workspaceId       String
  court             String?
  judge             String?
  status            String    @default("active") // 'active' | 'inactive' | 'closed'
  nextCourtDate     DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  lastActivityAt    DateTime  @default(now())
  lastClientContact DateTime?

  workspace            Workspace             @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  client               Client                @relation(fields: [clientId], references: [id])
  assignedLawyer       User                  @relation("AssignedMatters", fields: [assignedLawyerId], references: [id])
  activityLogs         MatterActivityLog[]
  clientCommunications ClientCommunication[]
  notifications        Notification[]
  briefs               Brief[]
  invoices             Invoice[]
  tasks                Task[]

  @@index([assignedLawyerId])
  @@index([workspaceId])
  @@index([lastActivityAt])
  @@index([nextCourtDate])
}

model MatterActivityLog {
  id           String   @id @default(cuid())
  matterId     String
  activityType String // 'note_added' | 'document_uploaded' | 'status_changed' | 'client_contacted' | 'court_date_added'
  description  String
  performedBy  String
  timestamp    DateTime @default(now())

  matter Matter @relation(fields: [matterId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [performedBy], references: [id])

  @@index([matterId, timestamp])
}

model ClientCommunication {
  id                String   @id @default(cuid())
  matterId          String
  clientId          String
  communicationType String // 'email' | 'phone' | 'meeting' | 'sms' | 'letter'
  subject           String
  summary           String
  sentBy            String
  sentAt            DateTime @default(now())

  matter Matter @relation(fields: [matterId], references: [id], onDelete: Cascade)
  client Client @relation(fields: [clientId], references: [id])
  user   User   @relation(fields: [sentBy], references: [id])

  @@index([matterId])
  @@index([clientId])
  @@index([sentAt])
}

model Brief {
  id          String    @id @default(cuid())
  briefNumber String    @unique
  name        String
  clientId    String
  matterId    String?
  lawyerId    String
  workspaceId String
  category    String // 'Litigation' | 'ADR' | 'Tax advisory' | etc.
  status      String    @default("active") // 'active' | 'inactive' | 'finalized'
  dueDate     DateTime?
  description String?

  // Email Integration
  inboundEmailId String @unique @default(uuid())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspace     Workspace          @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  client        Client             @relation(fields: [clientId], references: [id])
  matter        Matter?            @relation(fields: [matterId], references: [id])
  lawyer        User               @relation(fields: [lawyerId], references: [id])
  notifications Notification[]
  documents     Document[]
  tasks         Task[]
  activityLogs  BriefActivityLog[]

  @@index([lawyerId])
  @@index([workspaceId])
  @@index([dueDate])
  @@index([status])
}

model Document {
  id         String   @id @default(cuid())
  name       String
  url        String
  type       String // 'pdf', 'docx', etc.
  size       Int
  briefId    String
  uploadedAt DateTime @default(now())
  ocrStatus  String   @default("pending") // 'pending' | 'processing' | 'completed' | 'failed'
  ocrText    String?

  brief Brief @relation(fields: [briefId], references: [id], onDelete: Cascade)

  @@index([briefId])

  chunks     DocumentChunk[]
}

model DocumentChunk {
  id         String   @id @default(cuid())
  documentId String
  content    String   @db.Text
  embedding  Unsupported("vector(768)")? // Standard OpenAI/Gemini embedding size
  chunkIndex Int
  metadata   Json?    // Page number, bbox, etc.
  
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
}

model Client {
  id          String   @id @default(cuid())
  name        String
  email       String   @unique
  phone       String?
  company     String?
  industry    String?
  status      String   @default("active") // 'active' | 'inactive'
  workspaceId String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace            Workspace             @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  matters              Matter[]
  briefs               Brief[]
  clientCommunications ClientCommunication[]
  invoices             Invoice[]
  payments             Payment[]

  @@index([email])
  @@index([workspaceId])
}

model Invoice {
  id            String  @id @default(cuid())
  invoiceNumber String  @unique
  clientId      String
  matterId      String?

  // Invoice Details
  date    DateTime  @default(now())
  dueDate DateTime?
  status  String    @default("pending") // 'paid' | 'pending' | 'overdue'

  // Bill To Information
  billToName    String
  billToAddress String?
  billToCity    String?
  billToState   String?

  // Additional Fields
  attentionTo String? // e.g., "Sven Hanson"
  notes       String? // Additional notes or payment instructions

  // Amounts (stored in kobo/cents)
  subtotal             Int   @default(0)
  vatRate              Float @default(7.5) // VAT percentage
  vatAmount            Int   @default(0)
  securityChargeRate   Float @default(1.0) // Security charge percentage
  securityChargeAmount Int   @default(0)
  totalAmount          Int   @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client   Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  matter   Matter?       @relation(fields: [matterId], references: [id])
  payments Payment[]
  items    InvoiceItem[] // Line items

  @@index([clientId])
  @@index([matterId])
  @@index([status])
  @@index([date])
}

model InvoiceItem {
  id        String @id @default(cuid())
  invoiceId String

  description String // e.g., "PROFESSIONAL FEE FOR: RECENT INTERFACE WITH EFCC..."
  amount      Int // Amount in kobo/cents
  quantity    Int    @default(1)
  order       Int    @default(0) // For ordering items

  createdAt DateTime @default(now())

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

model Payment {
  id        String   @id @default(cuid())
  clientId  String
  invoiceId String?
  amount    Int
  date      DateTime @default(now())
  method    String
  reference String?
  createdAt DateTime @default(now())

  client  Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  invoice Invoice? @relation(fields: [invoiceId], references: [id])

  @@index([clientId])
  @@index([invoiceId])
}

model Expense {
  id          String   @id @default(cuid())
  workspaceId String
  category    String // 'Office Repairs' | 'Costs of Filing Processes' | 'Transportation to Court (Lawyers)' | 'Entertainment' | 'Local Fees' | 'Staff Salary' | 'Other'
  amount      Int // Amount in kobo/cents
  description String
  date        DateTime @default(now())
  reference   String? // Optional reference number
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([date])
}

// ============================================
// TASK MANAGEMENT MODELS
// ============================================

model Task {
  id           String    @id @default(cuid())
  title        String
  description  String?
  assignedToId String?
  assignedById String
  workspaceId  String
  matterId     String?
  briefId      String?
  priority     String    @default("medium") // 'low' | 'medium' | 'high' | 'urgent'
  status       String    @default("pending") // 'pending' | 'in_progress' | 'completed' | 'cancelled'
  dueDate      DateTime?
  completedAt  DateTime?

  // Email parsing fields
  source       String  @default("manual") // 'manual' | 'email' | 'integration'
  sourceEmail  String? // Email address that sent the task
  emailSubject String? // Original email subject
  emailBody    String? @db.Text // Original email body
  aiConfidence Int? // AI parsing confidence (0-100)

  // Metadata
  requirements Json? // Array of requirements
  attachments  Json? // Array of attachment URLs

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  assignedTo User?     @relation("AssignedTasks", fields: [assignedToId], references: [id])
  assignedBy User      @relation("CreatedTasks", fields: [assignedById], references: [id])
  workspace  Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  matter     Matter?   @relation(fields: [matterId], references: [id])
  brief      Brief?    @relation(fields: [briefId], references: [id])

  @@index([assignedToId, status, dueDate])
  @@index([workspaceId, status])
  @@index([sourceEmail])
  @@index([dueDate])
}

model WorkspaceEmailConfig {
  id               String   @id @default(cuid())
  workspaceId      String   @unique
  emailAddress     String   @unique // tasks-[workspace-id]@reforma.app
  isActive         Boolean  @default(true)
  emailIntegration Json? // OAuth tokens for Gmail/Outlook (future)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
}

model BriefActivityLog {
  id           String   @id @default(cuid())
  briefId      String
  activityType String // 'note_added' | 'email_received' | 'status_changed' | 'document_uploaded'
  description  String
  metadata     Json? // Store email subject, sender, etc.
  performedBy  String? // Null if system/email
  timestamp    DateTime @default(now())

  brief Brief @relation(fields: [briefId], references: [id], onDelete: Cascade)
  user  User? @relation(fields: [performedBy], references: [id])

  @@index([briefId, timestamp])
}

// ============================================
// INTELLIGENT DRAFTING ENGINE MODELS
// ============================================

model DraftingTemplate {
  id          String   @id @default(cuid())
  name        String
  description String?
  category    String // 'contracts', 'litigation', 'letters'
  workspaceId String? // If null, it's a System Global Template
  authorId    String
  isPublished Boolean  @default(false)
  version     Int      @default(1)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  nodes       DraftingNode[]
  sessions    DraftingSession[]
  variables   DraftingVariable[]

  workspace   Workspace? @relation(fields: [workspaceId], references: [id])
  author      User       @relation(fields: [authorId], references: [id])

  @@index([workspaceId])
}

model DraftingNode {
  id          String   @id @default(cuid())
  templateId  String
  type        String // 'QUESTION', 'CLAUSE', 'INFO', 'LOGIC_GATE'
  
  // Content
  content     String   @db.Text // The question text OR the clause text
  helpText    String?  @db.Text // Socratic explanation: "Why are we asking this?"
  
  // Logic
  order       Int      // Default sequence
  variableName String? // If this is a question, answer is stored under this var key
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  template    DraftingTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  options     NodeOption[]
  responses   DraftingResponse[]
  
  @@index([templateId, order])
}

model NodeOption {
  id          String   @id @default(cuid())
  nodeId      String
  label       String   // "Fixed Term"
  value       String   // "fixed_term"
  
  // Branching Logic
  nextNodeId  String?  // Jump to this node if selected (overrides default order)
  
  node        DraftingNode @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  
  @@index([nodeId])
}

model DraftingVariable {
  id          String   @id @default(cuid())
  templateId  String
  name        String   // "rent_amount"
  label       String   // "Annual Rent"
  type        String   // 'text', 'number', 'date', 'currency'
  required    Boolean  @default(true)
  defaultValue String?

  template    DraftingTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  
  @@unique([templateId, name])
}

model DraftingSession {
  id          String   @id @default(cuid())
  templateId  String
  userId      String
  status      String   // 'in_progress', 'completed', 'abandoned'
  currentStepId String? // ID of the node user is currently on
  
  // New Fields for "Fresh Drafting"
  mode        String   @default("template") // 'template' | 'fresh' | 'review'
  context     Json?    // The "Strategy/Instruction" derived from user prompt
  
  // Compiled Data
  variables   Json?    // Flattened map of all answers { rent_amount: 50000 }
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  template    DraftingTemplate @relation(fields: [templateId], references: [id])
  user        User             @relation(fields: [userId], references: [id])
  responses   DraftingResponse[]
  
  @@index([userId, status])
}

model DraftingResponse {
  id          String   @id @default(cuid())
  sessionId   String
  nodeId      String
  value       String   @db.Text // The user's answer
  
  timestamp   DateTime @default(now())

  session     DraftingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  node        DraftingNode    @relation(fields: [nodeId], references: [id])
  
  @@unique([sessionId, nodeId])
}
