// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTHENTICATION & WORKSPACE MODELS
// ============================================

model Workspace {
  id        String   @id @default(cuid())
  name      String   // "ASCO LP"
  slug      String   @unique // "asco-lp"
  ownerId   String
  plan      String   @default("free") // 'free' | 'pro' | 'enterprise'
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner       User              @relation("WorkspaceOwner", fields: [ownerId], references: [id])
  members     WorkspaceMember[]
  invitations Invitation[]
  matters     Matter[]
  clients     Client[]
  briefs      Brief[]
  expenses    Expense[]

  @@index([slug])
}

model WorkspaceMember {
  id          String   @id @default(cuid())
  workspaceId String
  userId      String
  role        String   // 'owner' | 'partner' | 'lawyer' | 'staff'
  joinedAt    DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@index([userId])
}

model Invitation {
  id          String    @id @default(cuid())
  workspaceId String
  email       String
  role        String    // 'partner' | 'lawyer' | 'staff'
  token       String    @unique
  invitedBy   String
  status      String    @default("pending") // 'pending' | 'accepted' | 'expired'
  expiresAt   DateTime
  createdAt   DateTime  @default(now())
  acceptedAt  DateTime?

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  inviter   User      @relation(fields: [invitedBy], references: [id])

  @@index([token])
  @@index([email])
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?   // Hashed with bcrypt (Optional for OAuth users)
  phone         String?   // Phone number
  accounts      Account[]
  sessions      Session[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // App Relations
  ownedWorkspaces      Workspace[]         @relation("WorkspaceOwner")
  workspaces           WorkspaceMember[]
  sentInvitations      Invitation[]
  assignedMatters      Matter[]            @relation("AssignedMatters")
  activityLogs         MatterActivityLog[]
  clientCommunications ClientCommunication[]
  briefs               Brief[]

  @@index([email])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// NOTIFICATION ENGINE MODELS
// ============================================

model Notification {
  id              String    @id @default(cuid())
  type            String    // 'alert' | 'info' | 'success' | 'warning' | 'critical'
  title           String
  message         String
  recipientId     String
  recipientType   String    // 'lawyer' | 'client' | 'partner' | 'staff'
  relatedMatterId String?
  relatedBriefId  String?
  priority        String    // 'low' | 'medium' | 'high' | 'critical'
  status          String    @default("unread") // 'unread' | 'read' | 'dismissed' | 'actioned'
  channels        String    // JSON array: ['in-app', 'email', 'sms']
  createdAt       DateTime  @default(now())
  readAt          DateTime?
  actionedAt      DateTime?

  matter Matter? @relation(fields: [relatedMatterId], references: [id])
  brief  Brief?  @relation(fields: [relatedBriefId], references: [id])

  @@index([recipientId, status])
  @@index([createdAt])
}

model NotificationRule {
  id          String   @id @default(cuid())
  name        String
  description String?
  triggerType String   // 'time' | 'event' | 'inactivity'
  conditions  String   // JSON object
  actions     String   // JSON object
  enabled     Boolean  @default(true)
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([enabled])
}

model Matter {
  id                String    @id @default(cuid())
  caseNumber        String    @unique
  name              String
  clientId          String
  assignedLawyerId  String
  workspaceId       String
  court             String?
  judge             String?
  status            String    @default("active") // 'active' | 'inactive' | 'closed'
  nextCourtDate     DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  lastActivityAt    DateTime  @default(now())
  lastClientContact DateTime?

  workspace            Workspace             @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  client               Client                @relation(fields: [clientId], references: [id])
  assignedLawyer       User                  @relation("AssignedMatters", fields: [assignedLawyerId], references: [id])
  activityLogs         MatterActivityLog[]
  clientCommunications ClientCommunication[]
  notifications        Notification[]
  briefs               Brief[]
  invoices             Invoice[]

  @@index([assignedLawyerId])
  @@index([workspaceId])
  @@index([lastActivityAt])
  @@index([nextCourtDate])
}

model MatterActivityLog {
  id           String   @id @default(cuid())
  matterId     String
  activityType String   // 'note_added' | 'document_uploaded' | 'status_changed' | 'client_contacted' | 'court_date_added'
  description  String
  performedBy  String
  timestamp    DateTime @default(now())

  matter Matter @relation(fields: [matterId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [performedBy], references: [id])

  @@index([matterId, timestamp])
}

model ClientCommunication {
  id                String   @id @default(cuid())
  matterId          String
  clientId          String
  communicationType String   // 'email' | 'phone' | 'meeting' | 'sms' | 'letter'
  subject           String
  summary           String
  sentBy            String
  sentAt            DateTime @default(now())

  matter Matter @relation(fields: [matterId], references: [id], onDelete: Cascade)
  client Client @relation(fields: [clientId], references: [id])
  user   User   @relation(fields: [sentBy], references: [id])

  @@index([matterId])
  @@index([clientId])
  @@index([sentAt])
}

model Brief {
  id          String    @id @default(cuid())
  briefNumber String    @unique
  name        String
  clientId    String
  matterId    String?
  lawyerId    String
  workspaceId String
  category    String    // 'Litigation' | 'ADR' | 'Tax advisory' | etc.
  status      String    @default("active") // 'active' | 'inactive' | 'finalized'
  dueDate     DateTime?
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  workspace     Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  client        Client         @relation(fields: [clientId], references: [id])
  matter        Matter?        @relation(fields: [matterId], references: [id])
  lawyer        User           @relation(fields: [lawyerId], references: [id])
  notifications Notification[]
  documents     Document[]

  @@index([lawyerId])
  @@index([workspaceId])
  @@index([dueDate])
  @@index([status])
}

model Document {
  id          String   @id @default(cuid())
  name        String
  url         String
  type        String   // 'pdf', 'docx', etc.
  size        Int
  briefId     String
  uploadedAt  DateTime @default(now())
  ocrStatus   String   @default("pending") // 'pending' | 'processing' | 'completed' | 'failed'
  ocrText     String?  // Removed @db.Text as it might not be needed or specific to postgres, but usually string is fine. Prisma Text is String. In Postgres String is text.
                       // Actually @db.Text is useful for large text. Let's keep it if valid or just String.
                       // In Prisma schema for postgres, String is usually text. But for very large content, sometimes explicit mapping is good.
                       // Let's just use String for now, standard Prisma.
  
  brief       Brief    @relation(fields: [briefId], references: [id], onDelete: Cascade)
  
  @@index([briefId])
}

model Client {
  id         String    @id @default(cuid())
  name       String
  email      String    @unique
  phone      String?
  company    String?
  industry   String?
  status     String    @default("active") // 'active' | 'inactive'
  workspaceId String
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  workspace            Workspace             @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  matters              Matter[]
  briefs               Brief[]
  clientCommunications ClientCommunication[]
  invoices             Invoice[]
  payments             Payment[]

  @@index([email])
  @@index([workspaceId])
}

model Invoice {
  id            String   @id @default(cuid())
  invoiceNumber String   @unique
  clientId      String
  matterId      String?
  
  // Invoice Details
  date          DateTime @default(now())
  dueDate       DateTime?
  status        String   @default("pending") // 'paid' | 'pending' | 'overdue'
  
  // Bill To Information
  billToName        String
  billToAddress     String?
  billToCity        String?
  billToState       String?
  
  // Additional Fields
  attentionTo       String?  // e.g., "Sven Hanson"
  notes             String?  // Additional notes or payment instructions
  
  // Amounts (stored in kobo/cents)
  subtotal          Int      @default(0)
  vatRate           Float    @default(7.5) // VAT percentage
  vatAmount         Int      @default(0)
  securityChargeRate Float   @default(1.0) // Security charge percentage
  securityChargeAmount Int   @default(0)
  totalAmount       Int      @default(0)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  client       Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  matter       Matter?       @relation(fields: [matterId], references: [id])
  payments     Payment[]
  items        InvoiceItem[] // Line items

  @@index([clientId])
  @@index([matterId])
  @@index([status])
  @@index([date])
}

model InvoiceItem {
  id          String  @id @default(cuid())
  invoiceId   String
  
  description String  // e.g., "PROFESSIONAL FEE FOR: RECENT INTERFACE WITH EFCC..."
  amount      Int     // Amount in kobo/cents
  quantity    Int     @default(1)
  order       Int     @default(0) // For ordering items
  
  createdAt   DateTime @default(now())
  
  invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  @@index([invoiceId])
}

model Payment {
  id        String   @id @default(cuid())
  clientId  String
  invoiceId String?
  amount    Int
  date      DateTime @default(now())
  method    String
  reference String?
  createdAt DateTime @default(now())

  client  Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  invoice Invoice? @relation(fields: [invoiceId], references: [id])

  @@index([clientId])
  @@index([invoiceId])
}

model Expense {
  id          String   @id @default(cuid())
  workspaceId String
  category    String   // 'Office Repairs' | 'Costs of Filing Processes' | 'Transportation to Court (Lawyers)' | 'Entertainment' | 'Local Fees' | 'Staff Salary' | 'Other'
  amount      Int      // Amount in kobo/cents
  description String
  date        DateTime @default(now())
  reference   String?  // Optional reference number
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([date])
  @@index([category])
}

 
 / /   = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = 
 / /   T A S K   M A N A G E M E N T   M O D E L S 
 / /   = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = 
 
 m o d e l   T a s k   { 
     i d                             S t r i n g         @ i d   @ d e f a u l t ( c u i d ( ) ) 
     t i t l e                       S t r i n g 
     d e s c r i p t i o n           S t r i n g ? 
     a s s i g n e d T o I d         S t r i n g ? 
     a s s i g n e d B y I d         S t r i n g 
     w o r k s p a c e I d           S t r i n g 
     m a t t e r I d                 S t r i n g ? 
     b r i e f I d                   S t r i n g ? 
     p r i o r i t y                 S t r i n g         @ d e f a u l t ( \  
 m e d i u m \ )   / /   ' l o w '   |   ' m e d i u m '   |   ' h i g h '   |   ' u r g e n t ' 
     s t a t u s                     S t r i n g         @ d e f a u l t ( \ p e n d i n g \ )   / /   ' p e n d i n g '   |   ' i n _ p r o g r e s s '   |   ' c o m p l e t e d '   |   ' c a n c e l l e d ' 
     d u e D a t e                   D a t e T i m e ? 
     c o m p l e t e d A t           D a t e T i m e ? 
     
     / /   E m a i l   p a r s i n g   f i e l d s 
     s o u r c e                     S t r i n g         @ d e f a u l t ( \ m a n u a l \ )   / /   ' m a n u a l '   |   ' e m a i l '   |   ' i n t e g r a t i o n ' 
     s o u r c e E m a i l           S t r i n g ?       / /   E m a i l   a d d r e s s   t h a t   s e n t   t h e   t a s k 
     e m a i l S u b j e c t         S t r i n g ?       / /   O r i g i n a l   e m a i l   s u b j e c t 
     e m a i l B o d y               S t r i n g ?       @ d b . T e x t   / /   O r i g i n a l   e m a i l   b o d y 
     a i C o n f i d e n c e         I n t ?             / /   A I   p a r s i n g   c o n f i d e n c e   ( 0 - 1 0 0 ) 
     
     / /   M e t a d a t a 
     r e q u i r e m e n t s         J s o n ?           / /   A r r a y   o f   r e q u i r e m e n t s 
     a t t a c h m e n t s           J s o n ?           / /   A r r a y   o f   a t t a c h m e n t   U R L s 
     
     c r e a t e d A t               D a t e T i m e     @ d e f a u l t ( n o w ( ) ) 
     u p d a t e d A t               D a t e T i m e     @ u p d a t e d A t 
     
     / /   R e l a t i o n s 
     a s s i g n e d T o             U s e r ?           @ r e l a t i o n ( \ A s s i g n e d T a s k s \ ,   f i e l d s :   [ a s s i g n e d T o I d ] ,   r e f e r e n c e s :   [ i d ] ) 
     a s s i g n e d B y             U s e r             @ r e l a t i o n ( \ C r e a t e d T a s k s \ ,   f i e l d s :   [ a s s i g n e d B y I d ] ,   r e f e r e n c e s :   [ i d ] ) 
     w o r k s p a c e               W o r k s p a c e   @ r e l a t i o n ( f i e l d s :   [ w o r k s p a c e I d ] ,   r e f e r e n c e s :   [ i d ] ,   o n D e l e t e :   C a s c a d e ) 
     m a t t e r                     M a t t e r ?       @ r e l a t i o n ( f i e l d s :   [ m a t t e r I d ] ,   r e f e r e n c e s :   [ i d ] ) 
     b r i e f                       B r i e f ?         @ r e l a t i o n ( f i e l d s :   [ b r i e f I d ] ,   r e f e r e n c e s :   [ i d ] ) 
     
     @ @ i n d e x ( [ a s s i g n e d T o I d ,   s t a t u s ,   d u e D a t e ] ) 
     @ @ i n d e x ( [ w o r k s p a c e I d ,   s t a t u s ] ) 
     @ @ i n d e x ( [ s o u r c e E m a i l ] ) 
     @ @ i n d e x ( [ d u e D a t e ] ) 
 } 
 
 m o d e l   W o r k s p a c e E m a i l C o n f i g   { 
     i d                             S t r i n g       @ i d   @ d e f a u l t ( c u i d ( ) ) 
     w o r k s p a c e I d           S t r i n g       @ u n i q u e 
     e m a i l A d d r e s s         S t r i n g       @ u n i q u e   / /   t a s k s - [ w o r k s p a c e - i d ] @ r e f o r m a . a p p 
     i s A c t i v e                 B o o l e a n     @ d e f a u l t ( t r u e ) 
     e m a i l I n t e g r a t i o n   J s o n ?       / /   O A u t h   t o k e n s   f o r   G m a i l / O u t l o o k   ( f u t u r e ) 
     c r e a t e d A t               D a t e T i m e   @ d e f a u l t ( n o w ( ) ) 
     u p d a t e d A t               D a t e T i m e   @ u p d a t e d A t 
     
     w o r k s p a c e   W o r k s p a c e   @ r e l a t i o n ( f i e l d s :   [ w o r k s p a c e I d ] ,   r e f e r e n c e s :   [ i d ] ,   o n D e l e t e :   C a s c a d e ) 
 } 
  
 